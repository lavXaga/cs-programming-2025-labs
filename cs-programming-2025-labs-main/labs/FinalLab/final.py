import random
import json

# ====== РАСЫ И ХАРАКТЕРИСТИКИ ======
расы = {
    "1": {"название": "Человек",
          "характеристики": {"здоровье": (80, 100), "атака": (10, 15), "защита": (8, 12), "ловкость": (10, 15),
                             "рост": (160, 190), "вес": (60, 90)}},
    "2": {"название": "Эльф",
          "характеристики": {"здоровье": (70, 85), "атака": (12, 18), "защита": (5, 10), "ловкость": (15, 20),
                             "рост": (170, 200), "вес": (50, 70)}},
    "3": {"название": "Дворф",
          "характеристики": {"здоровье": (90, 120), "атака": (15, 20), "защита": (12, 18), "ловкость": (5, 10),
                             "рост": (130, 150), "вес": (70, 100)}}
}

# ====== ТИПЫ КОМНАТ ======
типы_комнат = ["бой", "отдых", "сундук", "тайная"]

# ====== ПРЕДМЕТЫ ======
предметы_база = {
    "оружие": [
        {"название": "Ржавый меч", "атака": 3},
        {"название": "Топор", "атака": 5},
        {"название": "Лук", "атака": 4},
        {"название": "Магический посох", "атака": 7}
    ],
    "броня": [
        {"название": "Кожаная броня", "защита": 2},
        {"название": "Кольчуга", "защита": 4},
        {"название": "Латный доспех", "защита": 6}
    ],
    "зелья": [
        {"название": "Малое зелье", "лечение": 20},
        {"название": "Среднее зелье", "лечение": 40},
        {"название": "Большое зелье", "лечение": 60}
    ]
}

# ====== ВРАГИ ======
враги_база = [
    {"название": "Гоблин", "здоровье": 30, "атака": 5, "защита": 2, "опыт": 20},
    {"название": "Скелет", "здоровье": 40, "атака": 7, "защита": 3, "опыт": 30},
    {"название": "Орк", "здоровье": 60, "атака": 10, "защита": 5, "опыт": 50},
    {"название": "Тролль", "здоровье": 80, "атака": 12, "защита": 8, "опыт": 70}
]


# ====== СОЗДАНИЕ ПЕРСОНАЖА ======
def создать_персонажа():
    print("=" * 50)
    print("СОЗДАНИЕ ПЕРСОНАЖА")
    print("=" * 50)

    # Выбор расы
    while True:
        print("\nВыберите расу:")
        for ключ, раса in расы.items():
            print(f"{ключ} - {раса['название']}")

        выбор = input("Ваш выбор (1-3): ")
        if выбор in расы:
            выбранная_раса = расы[выбор]
            break
        print("Неверный выбор!")

    # Генерация характеристик
    персонаж = {
        "раса": выбранная_раса["название"],
        "уровень": 1,
        "опыт": 0,
        "опыт_до_уровня": 100,
        "очки_навыков": 0
    }

    # Случайные характеристики в пределах расы
    for хар, (мин, макс) in выбранная_раса["характеристики"].items():
        значение = random.randint(мин, макс)
        персонаж[хар] = значение
        if хар == "здоровье":
            персонаж["здоровье_макс"] = значение

    # Экипировка и инвентарь
    персонаж["оружие"] = None
    персонаж["броня"] = None
    персонаж["инвентарь"] = []
    персонаж["монеты"] = random.randint(10, 50)

    # Добавляем начальное зелье
    персонаж["инвентарь"].append({"тип": "зелье", "название": "Малое зелье", "лечение": 20})

    print("\nПерсонаж создан!")
    показать_персонажа(персонаж)

    return персонаж


# ====== ПОКАЗАТЬ ХАРАКТЕРИСТИКИ ======
def показать_персонажа(персонаж):
    print("\n" + "=" * 50)
    print("ВАШ ПЕРСОНАЖ")
    print("=" * 50)
    print(f"Раса: {персонаж['раса']}")
    print(f"Уровень: {персонаж['уровень']}")
    print(f"Опыт: {персонаж['опыт']}/{персонаж['опыт_до_уровня']}")
    print(f"Здоровье: {персонаж['здоровье']}/{персонаж['здоровье_макс']}")
    атака_бонус = f"+{персонаж['оружие']['атака']}" if персонаж['оружие'] else ""
    защита_бонус = f"+{персонаж['броня']['защита']}" if персонаж['броня'] else ""
    print(f"Атака: {персонаж['атака']} {атака_бонус}")
    print(f"Защита: {персонаж['защита']} {защита_бонус}")
    print(f"Ловкость: {персонаж['ловкость']}")
    print(f"Рост/Вес: {персонаж['рост']}см / {персонаж['вес']}кг")
    print(f"Монеты: {персонаж['монеты']}")
    print(f"Очки навыков: {персонаж['очки_навыков']}")

    if персонаж["оружие"]:
        print(f"Оружие: {персонаж['оружие']['название']}")
    if персонаж["броня"]:
        print(f"Броня: {персонаж['броня']['название']}")


# ====== ПРОКАЧКА ======
def прокачать_персонажа(персонаж):
    if персонаж["очки_навыков"] == 0:
        print("У вас нет очков навыков!")
        return

    print("\n" + "=" * 50)
    print("ПРОКАЧКА ХАРАКТЕРИСТИК")
    print("=" * 50)

    while персонаж["очки_навыков"] > 0:
        print(f"\nОчков навыков: {персонаж['очки_навыков']}")
        print("1 - +10 к здоровью (1 очко)")
        print("2 - +2 к атаке (1 очко)")
        print("3 - +2 к защите (1 очко)")
        print("4 - +2 к ловкости (1 очко)")
        print("0 - Выйти")

        выбор = input("Ваш выбор: ")

        if выбор == "0":
            break
        elif выбор == "1" and персонаж["очки_навыков"] >= 1:
            персонаж["здоровье_макс"] += 10
            персонаж["здоровье"] += 10
            персонаж["очки_навыков"] -= 1
            print("Здоровье увеличено!")
        elif выбор == "2" and персонаж["очки_навыков"] >= 1:
            персонаж["атака"] += 2
            персонаж["очки_навыков"] -= 1
            print("Атака увеличена!")
        elif выбор == "3" and персонаж["очки_навыков"] >= 1:
            персонаж["защита"] += 2
            персонаж["очки_навыков"] -= 1
            print("Защита увеличена!")
        elif выбор == "4" and персонаж["очки_навыков"] >= 1:
            персонаж["ловкость"] += 2
            персонаж["очки_навыков"] -= 1
            print("Ловкость увеличена!")
        else:
            print("Неверный выбор или недостаточно очков!")


# ====== ИНВЕНТАРЬ ======
def показать_инвентарь(персонаж):
    print("\n" + "=" * 50)
    print("ИНВЕНТАРЬ")
    print("=" * 50)
    print(f"Монеты: {персонаж['монеты']}")

    if not персонаж["инвентарь"]:
        print("Инвентарь пуст!")
        return

    print("\nПредметы:")
    for i, предмет in enumerate(персонаж["инвентарь"], 1):
        if предмет["тип"] == "зелье":
            print(f"{i}. {предмет['название']} (лечение: {предмет['лечение']})")
        elif предмет["тип"] == "оружие":
            print(f"{i}. {предмет['название']} (атака: +{предмет['атака']})")
        elif предмет["тип"] == "броня":
            print(f"{i}. {предмет['название']} (защита: +{предмет['защита']})")
        else:
            print(f"{i}. {предмет['название']}")

    print("\n1 - Использовать предмет")
    print("2 - Выбросить предмет")
    print("0 - Назад")

    выбор = input("Ваш выбор: ")

    if выбор == "1":
        номер = input("Номер предмета для использования: ")
        if номер.isdigit() and 1 <= int(номер) <= len(персонаж["инвентарь"]):
            использовать_предмет(персонаж, int(номер) - 1)
    elif выбор == "2":
        номер = input("Номер предмета для удаления: ")
        if номер.isdigit() and 1 <= int(номер) <= len(персонаж["инвентарь"]):
            удаленный = персонаж["инвентарь"].pop(int(номер) - 1)
            print(f"Вы выбросили: {удаленный['название']}")


# ====== ИСПОЛЬЗОВАНИЕ ПРЕДМЕТА ======
def использовать_предмет(персонаж, индекс):
    предмет = персонаж["инвентарь"][индекс]

    if предмет["тип"] == "зелье":
        лечение = предмет["лечение"]
        старое_здоровье = персонаж["здоровье"]
        персонаж["здоровье"] = min(персонаж["здоровье_макс"], персонаж["здоровье"] + лечение)
        вылечено = персонаж["здоровье"] - старое_здоровье
        print(f"Вы использовали {предмет['название']} и восстановили {вылечено} здоровья!")
        del персонаж["инвентарь"][индекс]

    elif предмет["тип"] == "оружие":
        if персонаж["оружие"]:
            print(f"Вы сняли: {персонаж['оружие']['название']}")
            персонаж["инвентарь"].append(персонаж["оружие"])
        персонаж["оружие"] = предмет
        print(f"Вы экипировали: {предмет['название']}")
        del персонаж["инвентарь"][индекс]

    elif предмет["тип"] == "броня":
        if персонаж["броня"]:
            print(f"Вы сняли: {персонаж['броня']['название']}")
            персонаж["инвентарь"].append(персонаж["броня"])
        персонаж["броня"] = предмет
        print(f"Вы экипировали: {предмет['название']}")
        del персонаж["инвентарь"][индекс]

    else:
        print("Этот предмет нельзя использовать!")


# ====== РАСЧЕТ УКЛОНЕНИЯ ======
def расчет_уклонения(персонаж):
    # Формула: ловкость - штрафы за рост и вес
    база = персонаж["ловкость"]
    штраф_роста = abs(персонаж["рост"] - 170) // 10  # Оптимальный рост 170см
    штраф_веса = abs(персонаж["вес"] - 70) // 10  # Оптимальный вес 70кг
    уклонение = база - штраф_роста - штраф_веса
    return max(5, min(уклонение, 50))  # Ограничиваем от 5% до 50%


# ====== СОЗДАНИЕ ВРАГА ======
def создать_врага(уровень_игрока):
    враг = random.choice(враги_база).copy()
    # Усиливаем врага в зависимости от уровня игрока
    множитель = 1 + (уровень_игрока - 1) * 0.2
    враг["здоровье"] = int(враг["здоровье"] * множитель)
    враг["атака"] = int(враг["атака"] * множитель)
    враг["защита"] = int(враг["защита"] * множитель)
    враг["опыт"] = int(враг["опыт"] * множитель)
    return враг


# ====== БОЙ ======
def бой(персонаж):
    print("\n" + "=" * 50)
    print("БОЕВАЯ КОМНАТА")
    print("=" * 50)

    враг = создать_врага(персонаж["уровень"])
    print(f"Вы встретили: {враг['название']}")
    print(f"Здоровье врага: {враг['здоровье']}")
    print(f"Атака врага: {враг['атака']}")

    while враг["здоровье"] > 0 and персонаж["здоровье"] > 0:
        print("\n" + "-" * 30)
        print(f"Ваше здоровье: {персонаж['здоровье']}/{персонаж['здоровье_макс']}")
        print(f"Здоровье врага: {враг['здоровье']}")
        print("\n1 - Атаковать")
        print("2 - Использовать предмет")
        print("3 - Попытаться уклониться")
        print("4 - Показать характеристики")

        выбор = input("Ваш выбор: ")

        if выбор == "1":
            # Игрок атакует
            атака_игрока = персонаж["атака"]
            if персонаж["оружие"]:
                атака_игрока += персонаж["оружие"]["атака"]
            урон = max(1, атака_игрока - враг["защита"] // 2)
            враг["здоровье"] -= урон
            print(f"Вы нанесли {урон} урона!")

            # Враг атакует (если жив)
            if враг["здоровье"] > 0:
                шанс_уклонения = расчет_уклонения(персонаж)
                if random.randint(1, 100) <= шанс_уклонения:
                    print(f"Вы уклонились от атаки врага! (шанс: {шанс_уклонения}%)")
                else:
                    защита_игрока = персонаж["защита"]
                    if персонаж["броня"]:
                        защита_игрока += персонаж["броня"]["защита"]
                    урон_врага = max(1, враг["атака"] - защита_игрока // 2)
                    персонаж["здоровье"] -= урон_врага
                    print(f"{враг['название']} нанес вам {урон_врага} урона!")

        elif выбор == "2":
            показать_инвентарь(персонаж)
            # После использования предмета враг атакует
            if враг["здоровье"] > 0:
                защита_игрока = персонаж["защита"]
                if персонаж["броня"]:
                    защита_игрока += персонаж["броня"]["защита"]
                урон_врага = max(1, враг["атака"] - защита_игрока // 2)
                персонаж["здоровье"] -= урон_врага
                print(f"{враг['название']} нанес вам {урон_врага} урона!")

        elif выбор == "3":
            # Попытка уклониться и атаковать
            шанс_уклонения = расчет_уклонения(персонаж) + 20  # Бонус за специальное уклонение
            if random.randint(1, 100) <= шанс_уклонения:
                print(f"Вы успешно уклонились и контратаковали! (шанс: {шанс_уклонения}%)")
                атака_игрока = персонаж["атака"]
                if персонаж["оружие"]:
                    атака_игрока += персонаж["оружие"]["атака"]
                урон = max(1, атака_игрока - враг["защита"] // 4)  # Больше урона при контратаке
                враг["здоровье"] -= урон
                print(f"Вы нанесли {урон} урона в контратаке!")
            else:
                print("Не удалось уклониться!")
                урон_врага = max(1, враг["атака"])
                персонаж["здоровье"] -= урон_врага
                print(f"{враг['название']} нанес вам {урон_врага} урона!")

        elif выбор == "4":
            показать_персонажа(персонаж)
            continue

        else:
            print("Неверный выбор!")

    # Результат боя
    if персонаж["здоровье"] <= 0:
        print("\nВЫ ПРОИГРАЛИ!")
        return False
    else:
        print(f"\nПОБЕДА! Вы победили {враг['название']}!")
        опыт = враг["опыт"]
        персонаж["опыт"] += опыт
        print(f"Получено опыта: {опыт}")

        # Проверка уровня
        if персонаж["опыт"] >= персонаж["опыт_до_уровня"]:
            персонаж["уровень"] += 1
            персонаж["опыт"] = 0
            персонаж["опыт_до_уровня"] = int(персонаж["опыт_до_уровня"] * 1.5)
            персонаж["очки_навыков"] += 3
            персонаж["здоровье_макс"] += 20
            персонаж["здоровье"] = персонаж["здоровье_макс"]
            print(f"\nПоздравляем! Вы достигли {персонаж['уровень']} уровня!")
            print("Получено 3 очка навыков!")

        # Добыча
        добыча = random.choices(["монеты", "зелье", "оружие", "броня", "ничего"],
                                weights=[40, 30, 15, 10, 5])[0]

        if добыча == "монеты":
            монеты = random.randint(10, 50) * персонаж["уровень"]
            персонаж["монеты"] += монеты
            print(f"Найдено монет: {монеты}")
        elif добыча == "зелье":
            зелье = random.choice(предметы_база["зелья"]).copy()
            зелье["тип"] = "зелье"
            персонаж["инвентарь"].append(зелье)
            print(f"Найдено: {зелье['название']}")
        elif добыча == "оружие":
            оружие = random.choice(предметы_база["оружие"]).copy()
            оружие["тип"] = "оружие"
            персонаж["инвентарь"].append(оружие)
            print(f"Найдено: {оружие['название']}")
        elif добыча == "броня":
            броня = random.choice(предметы_база["броня"]).copy()
            броня["тип"] = "броня"
            персонаж["инвентарь"].append(броня)
            print(f"Найдено: {броня['название']}")

        return True


# ====== КОМНАТА ОТДЫХА ======
def комната_отдыха(персонаж):
    print("\n" + "=" * 50)
    print("КОМНАТА ОТДЫХА")
    print("=" * 50)
    print("Вы можете восстановить силы и потратить очки навыков")

    # Восстановление здоровья
    восстановление = персонаж["здоровье_макс"] // 2
    старое_здоровье = персонаж["здоровье"]
    персонаж["здоровье"] = min(персонаж["здоровье_макс"], персонаж["здоровье"] + восстановление)
    вылечено = персонаж["здоровье"] - старое_здоровье
    print(f"Вы отдохнули и восстановили {вылечено} здоровья")

    # Прокачка
    if персонаж["очки_навыков"] > 0:
        print(f"\nУ вас есть {персонаж['очки_навыков']} очков навыков")
        ответ = input("Хотите потратить очки навыков? (д/н): ")
        if ответ.lower() == "д":
            прокачать_персонажа(персонаж)


# ====== КОМНАТА С СУНДУКОМ ======
def комната_с_сундуком(персонаж):
    print("\n" + "=" * 50)
    print("КОМНАТА С СУНДУКОМ")
    print("=" * 50)

    # Тип сундука
    тип_сундука = random.choices(["обычный", "редкий", "эпический"], weights=[70, 25, 5])[0]
    print(f"Вы нашли {тип_сундука} сундук!")

    if тип_сундука == "обычный":
        предметы = 1
    elif тип_сундука == "редкий":
        предметы = 2
    else:  # эпический
        предметы = 3

    for i in range(предметы):
        тип_предмета = random.choices(["монеты", "зелье", "оружие", "броня"],
                                      weights=[30, 40, 20, 10])[0]

        if тип_предмета == "монеты":
            монеты = random.randint(20, 100) * персонаж["уровень"]
            персонаж["монеты"] += монеты
            print(f"Найдено монет: {монеты}")
        elif тип_предмета == "зелье":
            зелье = random.choice(предметы_база["зелья"]).copy()
            зелье["тип"] = "зелье"
            персонаж["инвентарь"].append(зелье)
            print(f"Найдено: {зелье['название']}")
        elif тип_предмета == "оружие":
            оружие = random.choice(предметы_база["оружие"]).copy()
            оружие["тип"] = "оружие"
            оружие["атака"] += персонаж["уровень"] - 1  # Усиливаем оружие
            персонаж["инвентарь"].append(оружие)
            print(f"Найдено: {оружие['название']}")
        elif тип_предмета == "броня":
            броня = random.choice(предметы_база["броня"]).copy()
            броня["тип"] = "броня"
            броня["защита"] += персонаж["уровень"] - 1  # Усиливаем броню
            персонаж["инвентарь"].append(броня)
            print(f"Найдено: {броня['название']}")


# ====== ГЕНЕРАЦИЯ КОМНАТ ======
def сгенерировать_комнаты():
    # Две случайные комнаты
    комнаты = random.choices(типы_комнат, k=2, weights=[40, 30, 25, 5])

    # Видимость комнат
    видимость = []
    for комната in комнаты:
        # 70% шанс увидеть комнату, 30% - неизвестно
        if random.random() < 0.7:
            if комната == "бой":
                видимость.append("Боевая комната")
            elif комната == "отдых":
                видимость.append("Комната отдыха")
            elif комната == "сундук":
                видимость.append("Сундук")
            else:
                видимость.append("Тайная комната")
        else:
            видимость.append("???")

    return комнаты, видимость


# ====== ОБРАБОТКА КОМНАТЫ ======
def обработать_комнату(тип_комнаты, персонаж):
    if тип_комнаты == "бой":
        return бой(персонаж)
    elif тип_комнаты == "отдых":
        комната_отдыха(персонаж)
        return True
    elif тип_комнаты == "сундук":
        комната_с_сундуком(персонаж)
        return True
    else:  # тайная комната
        print("\n" + "=" * 50)
        print("ТАЙНАЯ КОМНАТА")
        print("=" * 50)
        событие = random.choice(["двойной_опыт", "лечение", "проклятие", "торговец"])

        if событие == "двойной_опыт":
            print("Вы нашли источник магической энергии!")
            print("Следующий бой принесет двойной опыт!")
            персонаж["тайный_бонус"] = "двойной_опыт"
        elif событие == "лечение":
            print("Вы нашли магический фонтан!")
            персонаж["здоровье"] = персонаж["здоровье_макс"]
            print("Здоровье полностью восстановлено!")
        elif событие == "проклятие":
            print("Вы попали в ловушку!")
            урон = персонаж["здоровье_макс"] // 4
            персонаж["здоровье"] -= урон
            print(f"Вы потеряли {урон} здоровья!")
        else:  # торговец
            print("Вы встретили таинственного торговца!")
            if персонаж["монеты"] >= 50:
                ответ = input("Купить случайное зелье за 50 монет? (д/н): ")
                if ответ.lower() == "д":
                    персонаж["монеты"] -= 50
                    зелье = random.choice(предметы_база["зелья"]).copy()
                    зелье["тип"] = "зелье"
                    персонаж["инвентарь"].append(зелье)
                    print(f"Куплено: {зелье['название']}")
            else:
                print("У вас недостаточно монет!")

        return True


# ====== СОХРАНЕНИЕ ИГРЫ ======
def сохранить_игру(персонаж, этаж):
    данные = {
        "персонаж": персонаж,
        "этаж": этаж
    }

    with open("сохранение.json", "w", encoding="utf-8") as файл:
        json.dump(данные, файл, ensure_ascii=False, indent=2)

    print("Игра сохранена!")


# ====== ЗАГРУЗКА ИГРЫ ======
def загрузить_игру():
    try:
        with open("сохранение.json", "r", encoding="utf-8") as файл:
            данные = json.load(файл)
        print("Игра загружена!")
        return данные["персонаж"], данные["этаж"]
    except:
        print("Сохранение не найдено!")
        return None, 1


# ====== ОСНОВНАЯ ИГРА ======
def основная_игра():
    print("=" * 50)
    print("ТЕКСТОВАЯ RPG - ПОДЗЕМЕЛЬЯ И ДРАКОНЫ")
    print("=" * 50)

    # Меню загрузки
    print("\n1 - Новая игра")
    print("2 - Загрузить игру")

    выбор = input("Ваш выбор: ")

    if выбор == "2":
        персонаж, этаж = загрузить_игру()
        if not персонаж:
            персонаж = создать_персонажа()
            этаж = 1
    else:
        персонаж = создать_персонажа()
        этаж = 1

    # Основной игровой цикл
    комната_номер = 0

    while персонаж["здоровье"] > 0:
        комната_номер += 1

        # Переход на новый этаж каждые 5 комнат
        if комната_номер > 5:
            этаж += 1
            комната_номер = 1
            print(f"\n" + "=" * 50)
            print(f"ВЫ СПУСТИЛИСЬ НА ЭТАЖ {этаж}!")
            print("=" * 50)
            print("Враги стали сильнее, но и добыча ценнее!")

        print(f"\n" + "=" * 50)
        print(f"ЭТАЖ {этаж}, КОМНАТА {комната_номер}")
        print("=" * 50)

        # Показ состояния
        print(f"Здоровье: {персонаж['здоровье']}/{персонаж['здоровье_макс']}")
        print(f"Уровень: {персонаж['уровень']}")
        print(f"Монеты: {персонаж['монеты']}")

        # Генерация комнат
        комнаты, видимость = сгенерировать_комнаты()
        print(f"\nПеред вами развилка:")
        print(f"1 - Налево: {видимость[0]}")
        print(f"2 - Направо: {видимость[1]}")
        print("3 - Показать характеристики")
        print("4 - Открыть инвентарь")
        print("5 - Сохранить игру")
        print("6 - Выйти из игры")

        выбор = input("Ваш выбор: ")

        if выбор == "1":
            результат = обработать_комнату(комнаты[0], персонаж)
            if not результат:
                break
        elif выбор == "2":
            результат = обработать_комнату(комнаты[1], персонаж)
            if not результат:
                break
        elif выбор == "3":
            показать_персонажа(персонаж)
            комната_номер -= 1  # Не считаем эту комнату
        elif выбор == "4":
            показать_инвентарь(персонаж)
            комната_номер -= 1  # Не считаем эту комнату
        elif выбор == "5":
            сохранить_игру(персонаж, этаж)
            комната_номер -= 1  # Не считаем эту комнату
        elif выбор == "6":
            print("Выход из игры...")
            break
        else:
            print("Неверный выбор!")
            комната_номер -= 1

    # Конец игры
    if персонаж["здоровье"] <= 0:
        print("\n" + "=" * 50)
        print("ИГРА ОКОНЧЕНА")
        print("=" * 50)
        print(f"Вы достигли {этаж} этажа и {персонаж['уровень']} уровня")
        print(f"Накоплено монет: {персонаж['монеты']}")
        print("Спасибо за игру!")

    input("\nНажмите Enter для выхода...")


